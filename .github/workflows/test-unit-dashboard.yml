name: Dashboard Unit Tests

on:
  push:
    branches: [main]
    paths:
      - "packages/**/__tests__/**"
      - "packages/**/src/**"
      - "packages/**/components/**"
      - "packages/**/hooks/**"
      - "packages/**/lib/**"
      - "packages/**/app/**"
      - "packages/**/jest.config.js"
      - "packages/**/package.json"
      - ".github/workflows/test-unit-dashboard.yml"
  pull_request:
    branches: [main]
    paths:
      - "packages/**/__tests__/**"
      - "packages/**/src/**"
      - "packages/**/components/**"
      - "packages/**/hooks/**"
      - "packages/**/lib/**"
      - "packages/**/app/**"
      - "packages/**/jest.config.js"
      - "packages/**/package.json"
      - ".github/workflows/test-unit-dashboard.yml"
  workflow_dispatch:
    inputs:
      test_package:
        description: 'Package to test (or "all")'
        required: true
        default: 'dashboard'
        type: choice
        options:
          - dashboard
          - all

jobs:
  unit-tests-dashboard:
    runs-on: ubuntu-latest
    timeout-minutes: 15
    if: ${{ github.event.inputs.test_package == 'all' || github.event.inputs.test_package == 'dashboard' || github.event.inputs.test_package == '' }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 10.12.2

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20.x"
          cache: "pnpm"

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build packages
        run: pnpm build

      - name: Run dashboard unit tests
        run: |
          cd packages/dashboard
          pnpm test --coverage --watchAll=false
        env:
          CI: true

      - name: Upload coverage reports
        uses: codecov/codecov-action@v4
        with:
          file: packages/dashboard/coverage/lcov.info
          flags: dashboard
          name: dashboard-coverage
          fail_ci_if_error: false

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: dashboard-unit-test-results
          path: packages/dashboard/coverage/
          retention-days: 7

  # Other packages unit tests (only when "all" is selected)
  unit-tests-other-packages:
    runs-on: ubuntu-latest
    timeout-minutes: 20
    if: ${{ github.event.inputs.test_package == 'all' }}
    
    strategy:
      fail-fast: false
      matrix:
        package:
          - client
          - manifests
          - interwebjs
          - cli

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 10.12.2

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20.x"
          cache: "pnpm"

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build packages
        run: pnpm build

      - name: Run unit tests for ${{ matrix.package }}
        run: |
          cd packages/${{ matrix.package }}
          if [ "${{ matrix.package }}" = "client" ]; then
            pnpm tests:unit --coverage --watchAll=false --passWithNoTests
          else
            pnpm test --coverage --watchAll=false --passWithNoTests
          fi
        env:
          CI: true

      - name: Upload coverage for ${{ matrix.package }}
        uses: codecov/codecov-action@v4
        with:
          file: packages/${{ matrix.package }}/coverage/lcov.info
          flags: ${{ matrix.package }}-unit
          name: ${{ matrix.package }}-unit-coverage
          fail_ci_if_error: false

      - name: Upload test results for ${{ matrix.package }}
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.package }}-unit-test-results
          path: packages/${{ matrix.package }}/coverage/
          retention-days: 7

  test-summary:
    runs-on: ubuntu-latest
    needs: [unit-tests-dashboard, unit-tests-other-packages]
    if: always()
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download all test results
        uses: actions/download-artifact@v4
        with:
          path: test-results

      - name: Generate test summary
        run: |
          echo "# Dashboard Unit Test Results Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Check dashboard results
          if [ -d "test-results/dashboard-unit-test-results" ]; then
            echo "✅ **Dashboard unit tests completed**" >> $GITHUB_STEP_SUMMARY
          else
            echo "❌ **Dashboard unit tests failed or skipped**" >> $GITHUB_STEP_SUMMARY
          fi
          
          # Check other packages results (only if "all" was selected)
          if [ "${{ github.event.inputs.test_package }}" = "all" ]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "## Other Packages" >> $GITHUB_STEP_SUMMARY
            
            for package in client manifests interwebjs cli; do
              if [ -d "test-results/$package-unit-test-results" ]; then
                echo "✅ $package unit tests completed" >> $GITHUB_STEP_SUMMARY
              else
                echo "❌ $package unit tests failed or skipped" >> $GITHUB_STEP_SUMMARY
              fi
            done
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Coverage Reports" >> $GITHUB_STEP_SUMMARY
          echo "Coverage reports have been uploaded to Codecov for detailed analysis." >> $GITHUB_STEP_SUMMARY
