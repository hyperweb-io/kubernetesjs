apiVersion: v1
kind: Namespace
metadata:
  name: postgres-db
  labels:
    app.interweb.dev/managed: "true"
---
apiVersion: v1
kind: Secret
metadata:
  name: postgres-superuser
  namespace: postgres-db
  labels:
    app.interweb.dev/managed: "true"
    app.kubernetes.io/name: postgres-superuser
    app.kubernetes.io/component: database
stringData:
  username: postgres
  password: postgres123!
---
apiVersion: v1
kind: Secret
metadata:
  name: postgres-app-user
  namespace: postgres-db
  labels:
    app.interweb.dev/managed: "true"
    app.kubernetes.io/name: postgres-app-user
    app.kubernetes.io/component: database
stringData:
  username: appuser
  password: appuser123!
---
apiVersion: postgresql.cnpg.io/v1
kind: Cluster
metadata:
  name: postgres-cluster
  namespace: postgres-db
  labels:
    app.interweb.dev/managed: "true"
    app.kubernetes.io/name: postgres-cluster
    app.kubernetes.io/component: database
spec:
  instances: 1
  imageName: ghcr.io/cloudnative-pg/postgresql:16.4
  enablePDB: false
  superuserSecret:
    name: postgres-superuser
  storage:
    size: 2Gi
  resources:
    requests:
      cpu: 50m
      memory: 256Mi
    limits:
      cpu: 200m
      memory: 512Mi
  bootstrap:
    initdb:
      database: postgres
      owner: postgres
      encoding: UTF8
      localeCollate: en_US.UTF-8
      localeCType: en_US.UTF-8
      postInitSQL:
        - "CREATE USER appuser WITH PASSWORD 'appuser123!' CREATEDB;"
        - "GRANT CREATE ON DATABASE postgres TO appuser;"
        - "CREATE SCHEMA IF NOT EXISTS public;"
        - "GRANT ALL PRIVILEGES ON SCHEMA public TO appuser;"
  monitoring:
    enablePodMonitor: false
  affinity:
    enablePodAntiAffinity: true
    topologyKey: kubernetes.io/hostname
    podAntiAffinityType: preferred
---
apiVersion: postgresql.cnpg.io/v1
kind: Pooler
metadata:
  name: postgres-pooler
  namespace: postgres-db
  labels:
    app.interweb.dev/managed: "true"
    app.kubernetes.io/name: postgres-pooler
    app.kubernetes.io/component: connection-pooler
spec:
  cluster:
    name: postgres-cluster
  instances: 1
  type: rw
  pgbouncer:
    poolMode: transaction
    parameters:
      default_pool_size: "10"
      max_client_conn: "100"
      max_db_connections: "10"
      max_user_connections: "10"
      server_reset_query: DISCARD ALL
      log_connections: "1"
      log_disconnections: "1"
      log_pooler_errors: "1"
      server_idle_timeout: "30"
      client_idle_timeout: "60"
      server_login_retry: "5"
      query_timeout: "30"
      ignore_startup_parameters: extra_float_digits
      application_name_add_host: "1"
    template:
      metadata:
        labels:
          app.kubernetes.io/name: postgres-pooler
          app.kubernetes.io/component: connection-pooler
      spec:
        containers:
          - name: pgbouncer
            resources:
              requests:
                cpu: 20m
                memory: 32Mi
              limits:
                cpu: 100m
                memory: 128Mi
        affinity:
          podAntiAffinity:
            preferredDuringSchedulingIgnoredDuringExecution:
              - weight: 100
                podAffinityTerm:
                  labelSelector:
                    matchLabels:
                      cnpg.io/poolerName: postgres-pooler
                  topologyKey: kubernetes.io/hostname
